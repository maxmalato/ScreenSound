@page "/login"
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthAPI authAPI
@inject NavigationManager navigationManager
@inject ISnackbar ISnackbar

@attribute [AllowAnonymous]

<MudContainer MaxWidth="MaxWidth.Small" Class="d-flex align-center justify-center" Style="min-height: 80vh;">
    <MudPaper Class="pa-8 mud-width-full mud-elevation-4 rounded-lg">
        <AuthorizeView>
            <Authorized>
                <MudAlert Severity="Severity.Success" Variant="Variant.Outlined" Class="mud-width-full">
                    Conectado como @context.User.Identity.Name
                </MudAlert>
            </Authorized>
            
            <NotAuthorized>
                <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-8 fw-bold">Bem-vindo</MudText>
                
                <MudForm>
                    <MudTextField T="string" Label="E-mail" @bind-Value="email"
                                  Variant="Variant.Outlined" 
                                  Class="mb-4"
                                  Required="true" RequiredError="E-mail obrigatório!"
                                  Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Email"/>

                    <MudTextField T="string" Label="Senha" 
                                  @bind-Value="senha"
                                  InputType="@(_exibirSenha ? InputType.Text : InputType.Password)"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@(_exibirSenha ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                                  OnAdornmentClick="@(() => _exibirSenha = !_exibirSenha)"
                                  Variant="Variant.Outlined" 
                                  Class="mb-2"
                                  Required="true" RequiredError="Senha obrigatória!" />

                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary" 
                               FullWidth="true"
                               Class="py-3 mt-6 rounded-pill mud-text-transform-none" 
                               @onclick="FazerLogin" 
                               Disabled="_processando" 
                               StartIcon="@(_processando ? null : Icons.Material.Filled.Login)">
                        @if (_processando)
                        {
                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                            <MudText Class="ms-2 mud-text-transform-none">Acessando...</MudText>
                        }
                        else
                        {
                            <MudText Class="mud-text-transform-none">Acessar</MudText>
                        }
                    </MudButton>

                    <div class="d-flex justify-center mt-6">
                        <MudLink href="/registrar" Color="Color.Secondary" Underline="Underline.Hover" Class="mud-text-transform-none">
                            Não tem uma conta? Registre-se
                        </MudLink>
                    </div>
                </MudForm>
            </NotAuthorized>
        </AuthorizeView>
    </MudPaper>
</MudContainer>

<style>
    .mud-text-transform-none {
        text-transform: none !important;
    }
</style>

@code {
    private string? email;
    private string? senha;
    private bool _processando = false;
    private bool _exibirSenha = false;

    [SupplyParameterFromQuery]
    public string? ReturnUrl { get; set; }

    private async Task FazerLogin()
    {
        _processando = true;

        try
        {
            var response = await authAPI.LoginAsync(email, senha);

            if (response.Sucesso)
            {
                ISnackbar.Add("Login realizado com sucesso!", Severity.Success);
                navigationManager.NavigateTo(ReturnUrl ?? "/");
            }
            else
            {
                if (response.Erros is not null)
                {
                    foreach (var erro in response.Erros)
                    {
                        ISnackbar.Add(erro, Severity.Error);
                    }
                }
                else
                {
                    ISnackbar.Add("Ocorreu um erro desconhecido durante o login.", Severity.Error);
                }
            }
        }
        finally
        {
            _processando = false;
        }
    }
}
