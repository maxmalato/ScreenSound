@page "/login"
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthAPI authAPI
@inject NavigationManager navigationManager
@inject ISnackbar ISnackbar

@attribute [AllowAnonymous]

<MudPaper Class="px-8 pt-2 pb-4 mx-16 my-8" Justify="Justify.Center">
    <AuthorizeView>
        <Authorized>
            <MudText Typo="Typo.h6" Color="Color.Success">Conectado como @context.User.Identity.Name</MudText>
        </Authorized>
        <NotAuthorized>
            <MudForm>
                <MudTextField T="string" Label="Email" @bind-Value="email"
                              Variant="Variant.Outlined" Class="my-4"
                              Required="true" RequiredError="Email obrigatório!"
                              OnlyValidateIfDirty="true" />

                <MudTextField T="string" Label="Senha" 
                              @bind-Value="senha"
                              InputType="@(_exibirSenha ? InputType.Text : InputType.Password)"
                              Adornment="Adornment.End"
                              AdornmentIcon="@(_exibirSenha ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                              OnAdornmentClick="@(() => _exibirSenha = !_exibirSenha)"
                              AdornmentAriaLabel="Mostrar senha"
                              Variant="Variant.Outlined" 
                              Class="my-4"
                              Required="true" 
                              RequiredError="Senha obrigatória!"
                              OnlyValidateIfDirty="true" 
                              />

                <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="my-6" @onclick="FazerLogin" Disabled="_processando" StartIcon="@(_processando ? null : Icons.Material.Filled.Login)">
                    @if (_processando)
                    {
                        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                        <MudText Class="ms-2">Acessando</MudText>
                    }
                    else
                    {
                        <MudText>Acessar</MudText>
                    }
                </MudButton>

                <MudButton Variant="Variant.Text" Color="Color.Secondary" href="/registrar">
                    Não tem uma conta? Registre-se
                </MudButton>
            </MudForm>
        </NotAuthorized>
    </AuthorizeView>
</MudPaper>

@code {
    private string? email;
    private string? senha;
    private bool _processando = false;
    private bool _exibirSenha = false;

    [SupplyParameterFromQuery]
    public string? ReturnUrl { get; set; }

    private async Task FazerLogin()
    {
        _processando = true;

        try
        {
            var response = await authAPI.LoginAsync(email, senha);

            if (response.Sucesso)
            {
                ISnackbar.Add("Login realizado com sucesso!", Severity.Success);
                navigationManager.NavigateTo(ReturnUrl ?? "/");
            }
            else
            {
                if (response.Erros is not null)
                {
                    foreach (var erro in response.Erros)
                    {
                        ISnackbar.Add(erro, Severity.Error);
                    }
                }
                else
                {
                    ISnackbar.Add("Ocorreu um erro desconhecido durante o login.", Severity.Error);
                }
            }
        }
        finally
        {
            _processando = false;
        }
    }
}
