@page "/editar-artista/{NomeArtista}"

@inject ArtistaAPI ArtistaApi
@inject NavigationManager NavigationManager
@inject ISnackbar ISnackbar

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-10 mb-10">
    @if (Artista is not null)
    {
        <MudPaper Class="pa-8 mud-elevation-4 rounded-lg">
            <div class="d-flex align-center mb-8">
                <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Color="Color.Default" Href="/artistas" Class="mr-4" />
                <div>
                    <MudText Typo="Typo.h4" Class="fw-bold">@(_isEditing ? "Detalhes do Artista" : "Editando Perfil")</MudText>
                    <MudText Typo="Typo.subtitle2" Class="mud-text-secondary">Gerencie as informações e a classificação</MudText>
                </div>
            </div>

            <MudForm>
                <MudGrid Spacing="3">
                    <MudItem xs="12">
                        <MudTextField T="string" Label="Nome do Artista"
                                      @bind-Value="_nome"
                                      Variant="Variant.Outlined"
                                      Required="true"
                                      RequiredError="O nome é obrigatório."
                                      Disabled="@(_isEditing)"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Badge" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudTextField T="string" Label="Biografia"
                                      @bind-Value="_biografia"
                                      Variant="Variant.Outlined"
                                      Lines="5"
                                      Required="true"
                                      RequiredError="A biografia é obrigatória."
                                      Disabled="@(_isEditing)"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Description" />
                    </MudItem>

                    <MudItem xs="12" Class="d-flex flex-column align-center py-6">
                        <MudText Typo="Typo.h6" Class="mb-2">Sua Avaliação</MudText>
                        <MudRating @bind-SelectedValue="_classificacao" 
                                   Disabled="@(_isEditing)" 
                                   Size="Size.Large" 
                                   Color="Color.Warning" />
                        <MudText Typo="Typo.caption" Class="mt-2">
                            @(_classificacao > 0 ? $"Você deu nota {_classificacao}" : "Clique nas estrelas para avaliar")
                        </MudText>
                    </MudItem>

                    <MudItem xs="12" Class="d-flex flex-column flex-sm-row justify-end gap-3 mt-4">
                        @if (_isEditing)
                        {
                            <MudButton Variant="Variant.Filled" 
                                       Color="Color.Primary" 
                                       @onclick="HabilitarEdicao"
                                       StartIcon="@Icons.Material.Filled.Edit"
                                       Class="rounded-pill px-8 mud-text-transform-none">
                                Editar Perfil
                            </MudButton>

                            <MudButton Variant="Variant.Outlined" 
                                       Color="Color.Error" 
                                       @onclick="ConfirmarExclusao"
                                       StartIcon="@Icons.Material.Filled.Delete"
                                       Class="rounded-pill px-8 mud-text-transform-none">
                                Excluir Artista
                            </MudButton>
                        }
                        else
                        {
                            <MudButton Variant="Variant.Text" 
                                       Color="Color.Secondary" 
                                       @onclick="CancelarEdicao"
                                       Class="mud-text-transform-none">
                                Cancelar
                            </MudButton>

                            <MudButton Variant="Variant.Filled" 
                                       Color="Color.Success" 
                                       @onclick="Salvar"
                                       Disabled="_processando"
                                       StartIcon="@Icons.Material.Filled.Save"
                                       Class="rounded-pill px-10 mud-text-transform-none">
                                @if (_processando)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                    <span>Salvando...</span>
                                }
                                else
                                {
                                    <span>Salvar Alterações</span>
                                }
                            </MudButton>
                        }
                    </MudItem>
                </MudGrid>
            </MudForm>
        </MudPaper>
    }
    else
    {
        <MudPaper Class="pa-8 mud-elevation-4 rounded-lg">
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="50px" Width="40%" Class="mb-6" />
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="60px" Class="mb-4" />
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="150px" Class="mb-4" />
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="80px" Width="30%" Class="mx-auto" />
        </MudPaper>
    }
</MudContainer>

<style>
    .mud-text-transform-none {
        text-transform: none !important;
    }
</style>

@code {
    [Parameter] public string? NomeArtista { get; set; }
    public ArtistaResponse? Artista { get; set; }

    private string? _nome;
    private string? _biografia;
    private string? _fotoPerfil;
    private bool _isEditing = true;
    private bool _processando = false;
    private int _classificacao;
    private int _classificacaoOriginal;

    protected override async Task OnInitializedAsync()
    {
        try 
        {
            Artista = await ArtistaApi.GetArtistaPorNomeAsync(NomeArtista!);

            if (Artista is not null)
            {
                _nome = Artista.Nome;
                _biografia = Artista.Bio;
                var avaliacaoResponse = await ArtistaApi.GetAvaliacaoDaPessoaLogadaAsync(Artista.Id);
                _classificacao = (int)Math.Round(avaliacaoResponse?.Nota ?? 0);
                _classificacaoOriginal = _classificacao;
            }
        }
        catch (Exception ex)
        {
            ISnackbar.Add("Erro ao carregar dados do Azure.", Severity.Error);
        }
    }

    private void HabilitarEdicao() => _isEditing = false;

    private void CancelarEdicao()
    {
        _isEditing = true;
        _nome = Artista!.Nome;
        _biografia = Artista!.Bio;
        _classificacao = _classificacaoOriginal;
    }

    private async Task Salvar()
    {
        _processando = true;
        try
        {
            var requestEdit = new ArtistaRequestEdit(Artista!.Id, _nome!, _biografia!, _fotoPerfil);
            await ArtistaApi.UpdateArtistaAsync(requestEdit);
            await ArtistaApi.AvaliarArtistaAsync(Artista.Id, _classificacao);
            
            ISnackbar.Add("Perfil atualizado com sucesso!", Severity.Success);
            NavigationManager.NavigateTo("/artistas");
        }
        catch (Exception ex)
        {
            ISnackbar.Add("Erro ao salvar alterações.", Severity.Error);
        }
        finally
        {
            _processando = false;
        }
    }

    private async Task ConfirmarExclusao()
    {
        await Excluir();
    }

    private async Task Excluir()
    {
        try 
        {
            await ArtistaApi.DeleteArtistaAsync(Artista!.Id);
            ISnackbar.Add("Artista removido do catálogo.", Severity.Info);
            NavigationManager.NavigateTo("/artistas");
        }
        catch 
        {
            ISnackbar.Add("Erro ao excluir artista.", Severity.Error);
        }
    }
}