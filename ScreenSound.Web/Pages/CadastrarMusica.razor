@page "/cadastrar-musica"

@inject ArtistaAPI artistaAPI
@inject GeneroAPI generoAPI
@inject MusicaAPI musicaAPI
@inject NavigationManager navigationManager
@inject ISnackbar ISnackbar

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-10 mb-10">
    <MudPaper Class="pa-8 mud-elevation-4 rounded-lg">
        
        <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-8 fw-bold">Cadastrar Música</MudText>

        <MudForm @ref="_form" @bind-IsValid="@_success">
            <MudGrid Spacing="3">
                
                <MudItem xs="12">
                    <MudTextField T="string" Label="Título da Música"
                                  @bind-Value="_nome"
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  RequiredError="O título é obrigatório."
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.MusicNote" />
                </MudItem>

                <MudItem xs="12" sm="8">
                    <MudSelect T="ArtistaResponse" 
                               Label="Artista Responsável" 
                               Variant="Variant.Outlined" 
                               AnchorOrigin="Origin.BottomCenter"
                               TransformOrigin="Origin.TopCenter"
                               ValueChanged="ArtistaSelecionado"
                               Required="true"
                               RequiredError="Selecione um artista.">
                        @if (_artistas is not null)
                        {
                            @foreach (var artista in _artistas)
                            {
                                <MudSelectItem Value="artista">@artista.Nome</MudSelectItem>
                            }
                        }
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" sm="4">
                    <MudNumericField T="int" Label="Ano"
                                     @bind-Value="_anoLancamento"
                                     Variant="Variant.Outlined"
                                     Min="1900" Max="@DateTime.Now.Year"
                                     Required="true"
                                     RequiredError="Obrigatório."
                                     Adornment="Adornment.Start"
                                     AdornmentIcon="@Icons.Material.Filled.CalendarToday" />
                </MudItem>

                <MudItem xs="12">
                    <MudSelect T="GeneroResponse" 
                               Label="Adicionar Gêneros" 
                               Variant="Variant.Outlined" 
                               AnchorOrigin="Origin.BottomCenter"
                               TransformOrigin="Origin.TopCenter"
                               ValueChanged="GeneroSelecionado"
                               Class="mb-2">
                        @if (_generos is not null)
                        {
                            @foreach (var genero in _generos)
                            {
                                <MudSelectItem Value="genero">@genero.Nome</MudSelectItem>
                            }
                        }
                    </MudSelect>

                    <div class="d-flex flex-wrap gap-2 mt-2">
                        @if (GenerosSelecionados is not null && GenerosSelecionados.Any())
                        {
                            @foreach (var genero in GenerosSelecionados)
                            {
                                <MudChip T="GeneroResponse"
                                         Value="genero"
                                        Color="Color.Primary" 
                                         Variant="Variant.Filled" 
                                         OnClose="@(() => GenerosSelecionados.Remove(genero))"
                                         Class="mud-text-transform-none">
                                    @genero.Nome
                                </MudChip>
                            }
                        }
                        else
                        {
                            <MudText Typo="Typo.caption" Class="mud-text-secondary ml-2">
                                Selecione um ou mais gêneros para esta música.
                            </MudText>
                        }
                    </div>
                </MudItem>

                <MudItem xs="12" Class="d-flex flex-column flex-sm-row justify-end gap-3 mt-6">
                    <MudButton Variant="Variant.Text" 
                               Color="Color.Secondary" 
                               Href="/musicas-por-artista"
                               Class="mud-text-transform-none px-6">
                        Cancelar
                    </MudButton>

                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary" 
                               Class="px-10 rounded-pill mud-text-transform-none"
                               @onclick="Cadastrar"
                               Disabled="_processando">
                        @if (_processando)
                        {
                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                            <MudText Class="ms-2">Salvando...</MudText>
                        }
                        else
                        {
                            <MudText>Finalizar Cadastro</MudText>
                        }
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudForm>
    </MudPaper>
</MudContainer>

<style>
    .mud-text-transform-none {
        text-transform: none !important;
    }
</style>

@code {
    private MudForm _form = null!;
    private bool _success;
    private bool _processando = false;

    private int _anoLancamento = DateTime.Now.Year;
    private string? _nome;

    private ICollection<ArtistaResponse>? _artistas;
    private ICollection<GeneroResponse>? _generos;

    private List<GeneroResponse> GenerosSelecionados { get; set; } = new();
    private ArtistaResponse? ArtistaDaMusica { get; set; }

    protected override async Task OnInitializedAsync()
    {
        _artistas = await artistaAPI.GetArtistasAsync();
        _generos = await generoAPI.GetGenerosAsync();
    }

    private void ArtistaSelecionado(ArtistaResponse artistaSelecionado)
    {
        ArtistaDaMusica = artistaSelecionado;
    }

    private void GeneroSelecionado(GeneroResponse generoSelecionado)
    {
        if (generoSelecionado is not null && !GenerosSelecionados.Any(g => g.Id == generoSelecionado.Id))
        {
            GenerosSelecionados.Add(generoSelecionado);
        }
    }

    public async Task Cadastrar()
    {
        await _form.Validate();

        if (_form.IsValid)
        {
            if (ArtistaDaMusica == null)
            {
                ISnackbar.Add("Por favor, selecione um artista.", Severity.Warning);
                return;
            }

            _processando = true;
            try
            {
                var generoRequests = GenerosSelecionados
                    .Select(g => new GeneroRequest(g.Nome, g.Descricao))
                    .ToList();

                var musicaRequest = new MusicaRequest(_nome!, ArtistaDaMusica.Id, _anoLancamento, generoRequests);

                await musicaAPI.AddMusicaAsync(musicaRequest);
                
                ISnackbar.Add("Música cadastrada com sucesso!", Severity.Success);
                navigationManager.NavigateTo("/musicas-por-artista");
            }
            catch (Exception ex)
            {
                ISnackbar.Add($"Erro ao salvar no Azure: {ex.Message}", Severity.Error);
            }
            finally
            {
                _processando = false;
            }
        }
    }
}